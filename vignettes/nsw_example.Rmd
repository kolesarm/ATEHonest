---
title: "Honest CIs: NSW example"
author: "Michal KolesÃ¡r"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{Inference for Average Treatment Effects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include=FALSE, cache=FALSE}
library("knitr")
knitr::opts_knit$set(self.contained = FALSE)
knitr::opts_chunk$set(tidy = TRUE, collapse=TRUE, comment = "#>",
                      tidy.opts=list(blank=FALSE, width.cutoff=55))
```

The package `ATEHonest` implements honest inference for estimating average
treatment effects under unconfoundedness. Here we illustrate the use of the
package using NSW data.


The data is shipped with the package, as a data frame called `NSW`. First we
extract the design matrix, and the treatment and outcome vectors:

```{r}
X <- as.matrix(NSW[, 2:10])
## weight matrix
Ahalf <- diag(c(0.15, 0.6, 2.5, 2.5, 2.5, 0.5, 0.5, 0.1, 0.1))
d <- NSW$treated
y <- NSW$re78

## Compute matrix of distances between treated and control units
D0 <- distMat(X, d, Ahalf, method="manhattan", FullMatrix=FALSE)
```

Next, compute distance matrix for variance estimation, and compute NN variance estimator:
```{r}
Avar <- chol(solve(cov(X)))
DMvar <- distMat(X, d, Avar, method="euclidean",
                 FullMatrix=TRUE)
sigma2 <- nnvar(DMvar, d, y, J=30)
```

Now we compute the first 750 steps of the homotopy. This takes about 2mins on a desktop computer:
```{r}
r <- ATTh(D0, maxiter=750)
## throw away the first few steps for which delta is zero
res <- r$res[r$res[, "delta"]>0, ]
## Normalize delta by standard deviation so it's compatible with the paper:
res[, "delta"] <- res[, "delta"]/sqrt(mean(sigma2))

## res contains the optimal weights, use them to compute the estimator and CIs:
rr <- as.data.frame(ATTpath(res, d, y, C=1, mean(sigma2)))
```
At the last step the value of $\delta$ is given by
```{r}
res[nrow(res), "delta"]
```

# Graphs and tables for paper

Now plot like the one in Figure 5:
```{r fig.width=4.5, fig.height=6.5, fig.cap="Reproduction of Figure 5 in the paper"}
## See Figure 1 below for output
d1 <- reshape2::melt(rr[, c(1, 2, 3, 4, 7, 8)],
                          id.vars="delta")
p <- qplot(x=delta, y=value, data=d1, geom="line") +
     facet_grid( variable ~ ., scales="free_y") +
     theme_bw()
p
```

For now, to find optimal estimator, only look at $\delta$ at knot points (and
don't consider values between knot points). We should approximately match Table 1. Still need to implement optimal one-sided CI:
```{r}
res.opt <- res[c(which.min(rr$rmse), which.min(rr$hl)), ]
## Homoscedastic errors
as.data.frame(ATTpath(res.opt, d, y, C=1, mean(sigma2)))
## Heteroscedastic errors
as.data.frame(ATTpath(res.opt, d, y, C=1, sigma2))
```
